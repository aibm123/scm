<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Logistics Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-overlay { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .input-field {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }
        .input-field::placeholder { color: rgba(255, 255, 255, 0.5); }
        #fleetMap { height: 100%; width: 100%; background-color: #f1f5f9; }
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-100 antialiased">

    <!-- =========== LOGIN VIEW =========== -->
    <div id="loginView" class="min-h-screen flex items-center justify-center bg-gray-900 p-4" style="background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1577974338399-52d92a11b3b1?q=80&w=2070'); background-size: cover;">
        <div class="w-full max-w-sm">
            <div class="bg-white/10 backdrop-blur-sm rounded-2xl shadow-2xl p-8 text-center border border-white/20">
                <i class="fas fa-truck-fast text-5xl text-white mb-4"></i>
                <h1 class="text-3xl font-bold text-white mb-2">Logistics Command Center</h1>
                <p class="text-gray-300 mb-8">Đăng nhập để tiếp tục</p>
                <form id="loginForm">
                    <div class="space-y-4 text-left">
                        <div>
                            <label for="username" class="text-sm font-bold text-gray-300">Email</label>
                            <input type="text" id="username" name="username" placeholder="Nhập địa chỉ email" class="w-full mt-1 p-3 rounded-lg input-field focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
                        </div>
                        <div>
                            <label for="password" class="text-sm font-bold text-gray-300">Mật khẩu</label>
                            <input type="password" id="password" name="password" placeholder="••••••••" class="w-full mt-1 p-3 rounded-lg input-field focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-300 transform hover:-translate-y-1 shadow-lg mt-8">
                        Đăng Nhập
                    </button>
                    <p id="loginError" class="text-red-400 text-sm mt-4 h-5"></p>
                </form>
            </div>
             <div class="mt-6 p-4 bg-black/20 rounded-lg border border-white/20 text-left text-sm text-gray-300">
                <h4 class="font-semibold mb-2 text-white">Sử dụng tài khoản Baserow:</h4>
                <p><strong>Email:</strong> admin@gmail.com</p>
                <p><strong>Mật khẩu:</strong> 123</p>
            </div>
        </div>
    </div>

    <!-- =========== MAIN APPLICATION VIEW (Admin & Driver) =========== -->
    <div id="appView" class="hidden">
        <!-- Admin View -->
        <div id="adminView" class="hidden h-screen w-screen flex">
            <aside class="w-64 bg-gray-800 text-gray-300 flex flex-col">
                <div class="p-4 border-b border-gray-700 flex items-center gap-3">
                    <i class="fas fa-truck-fast text-3xl text-white"></i>
                    <h1 class="text-xl font-bold text-white">LCC</h1>
                </div>
                <nav class="flex-1 p-4 space-y-2">
                    <a href="#" class="nav-item flex items-center p-3 rounded-lg transition-colors" data-target="chatbot">
                        <i class="fas fa-comments fa-fw w-6 text-center mr-3"></i>
                        <span>Chatbot</span>
                    </a>
                    <a href="#" class="nav-item flex items-center p-3 rounded-lg transition-colors" data-target="dashboard">
                        <i class="fas fa-tachometer-alt fa-fw w-6 text-center mr-3"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" class="nav-item flex items-center p-3 rounded-lg transition-colors" data-target="fleet">
                        <i class="fas fa-map-location-dot fa-fw w-6 text-center mr-3"></i>
                        <span>Giám Sát Đội Xe</span>
                    </a>
                    <a href="#" class="nav-item flex items-center p-3 rounded-lg transition-colors" data-target="shipments">
                        <i class="fas fa-box fa-fw w-6 text-center mr-3"></i>
                        <span>Quản Lý Lô Hàng</span>
                    </a>
                </nav>
                <div class="p-4 border-t border-gray-700">
                    <div class="flex items-center gap-3">
                        <img src="https://placehold.co/40x40/64748b/ffffff?text=A" class="rounded-full">
                        <div>
                            <p id="adminUsername" class="font-semibold text-white">Admin</p>
                            <a href="#" onclick="app.logout()" class="text-sm text-red-400 hover:text-red-300">Đăng xuất</a>
                        </div>
                    </div>
                </div>
            </aside>
            <main class="flex-1 bg-slate-100 overflow-y-auto">
                <!-- Admin Pages will be injected here -->
            </main>
        </div>

        <!-- DRIVER VIEW - A NORMAL, FULL-SCREEN RESPONSIVE PAGE -->
        <div id="driverView" class="hidden">
            <div class="min-h-screen flex flex-col">
                <header class="bg-gray-800 text-white shadow-md">
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between h-16">
                            <div class="flex items-center">
                               <i class="fas fa-truck text-2xl mr-3"></i>
                               <span class="font-semibold text-xl">Driver Portal</span>
                            </div>
                            <div class="flex items-center gap-4">
                               <span id="driverUsername" class="font-medium"></span>
                                <a href="#" onclick="app.logout()" class="text-sm text-red-400 hover:text-red-300 flex items-center gap-1">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>Đăng xuất</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </header>
                <main class="flex-1 bg-gray-100">
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div id="driverTaskContent" class="bg-white p-6 rounded-xl shadow-lg border max-w-2xl mx-auto">
                           <p class="text-center text-gray-500">Đang tải nhiệm vụ...</p>
                        </div>
                        <div class="mt-6 max-w-2xl mx-auto">
                             <button id="driverActionButton" class="w-full bg-gray-400 text-white font-bold py-4 px-4 rounded-xl text-lg transition duration-300 shadow-lg flex items-center justify-center gap-2" disabled>
                                Vui lòng chờ
                            </button>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    
    <!-- MODAL -->
    <div id="modalContainer" class="fixed inset-0 z-50 hidden">
        <!-- Overlay and Content will be added by JS -->
    </div>

    <script>
    class LogisticsApp {
        constructor() {
            this.state = {
                currentUser: null,
                activeAdminPage: 'chatbot',
                simulation: { running: false, interval: null, timer: 0 },
                locations: {},
                fleet: [],
                shipments: [],
                driverTask: null,
                map: null, 
                vehicleMarkers: {},
                threadId: null, 
            };
            
            this.apiConfig = {
                host: 'https://aibm.store',
                token: 'A4XpUa1X8DawIEiY2zDJPoyQbTCAHGC6',
                tables: {
                    users: 845,
                    locations: 860,
                    vehicles: 861,
                    shipments: 865,
                    events: 866,
                }
            };
            this.init();
        }

        init() {
            document.addEventListener('DOMContentLoaded', () => {
                this.cacheDOMElements();
                this.attachEventListeners();
                this.render();
            });
        }
        
        async fetchBaserowTable(tableId) {
            const apiUrl = `${this.apiConfig.host}/api/database/rows/table/${tableId}/?user_field_names=true`;
            const response = await fetch(apiUrl, {
                headers: { 'Authorization': `Token ${this.apiConfig.token}` }
            });
            if (!response.ok) throw new Error(`Failed to fetch table ${tableId}: ${response.status}`);
            const data = await response.json();
            return data.results;
        }

        async loadApiData() {
            try {
                const [locationsData, vehiclesData, shipmentsData] = await Promise.all([
                    this.fetchBaserowTable(this.apiConfig.tables.locations),
                    this.fetchBaserowTable(this.apiConfig.tables.vehicles),
                    this.fetchBaserowTable(this.apiConfig.tables.shipments)
                ]);

                this.state.locations = {};
                locationsData.forEach(loc => {
                    this.state.locations[loc['locate id']] = {
                        name: loc.name,
                        coords: [parseFloat(loc.latitude), parseFloat(loc.longitude)],
                        type: loc.type ? loc.type.value : 'unknown'
                    };
                });

                this.state.shipments = shipmentsData.map(ship => ({
                    id: ship['ship id'],
                    vehicle_id: ship.vehicle_id.length > 0 ? ship.vehicle_id[0].value : null,
                    origin_id: ship.origin_id.length > 0 ? ship.origin_id[0].value : null,
                    destination_id: ship.destination_id.length > 0 ? ship.destination_id[0].value : null,
                    status: ship.status ? ship.status.value : 'unknown'
                }));
                
                this.state.fleet = vehiclesData.map(v => {
                    const assignedShipment = this.state.shipments.find(s => s.vehicle_id === v['vehicles id']);
                    const route = assignedShipment ? [assignedShipment.origin_id, assignedShipment.destination_id] : [null, null];
                    
                    return {
                        id: v['vehicles id'],
                        driver_id: v['driver id'].length > 0 ? v['driver id'][0].id : null,
                        coords: [parseFloat(v.current_lat), parseFloat(v.current_lon)],
                        status: v.status ? v.status.value : 'unknown',
                        route: route,
                        hasAlert: (v.status ? v.status.value : '') === 'stopped',
                        progress: 0.1 
                    };
                });

                if (this.state.currentUser.role === 'driver') {
                    const myVehicle = this.state.fleet.find(v => v.driver_id === this.state.currentUser.id);
                    if (myVehicle) {
                        const myShipment = this.state.shipments.find(s => s.vehicle_id === myVehicle.id && s.status === 'on_route');
                        if (myShipment) {
                             this.state.driverTask = {
                                shipmentId: myShipment.id,
                                destination: this.state.locations[myShipment.destination_id]?.name || 'Không rõ',
                                eta: '17:30', 
                                status: myShipment.status
                            };
                        } else {
                             this.state.driverTask = { status: 'no_task' };
                        }
                    }
                }

            } catch (error) {
                console.error("Failed to load API data:", error);
                this.dom.loginError.textContent = 'Không thể tải dữ liệu từ server.';
                this.logout();
            }
        }

        cacheDOMElements() {
            this.dom = {
                loginView: document.getElementById('loginView'),
                appView: document.getElementById('appView'),
                adminView: document.getElementById('adminView'),
                driverView: document.getElementById('driverView'),
                adminMainContent: document.querySelector('#adminView main'),
                navItems: document.querySelectorAll('.nav-item'),
                modalContainer: document.getElementById('modalContainer'),
                loginForm: document.getElementById('loginForm'),
                loginError: document.getElementById('loginError'),
                adminUsername: document.getElementById('adminUsername'),
                driverUsername: document.getElementById('driverUsername'),
                driverTaskContent: document.getElementById('driverTaskContent'),
                driverActionButton: document.getElementById('driverActionButton'),
            };
        }

        attachEventListeners() {
            this.dom.loginForm.addEventListener('submit', (e) => this.handleLogin(e));
            this.dom.navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.state.activeAdminPage = e.target.closest('.nav-item').dataset.target;
                    this.render();
                });
            });
            this.dom.driverActionButton.addEventListener('click', () => this.handleDriverAction());
        }
        
        render() {
            if (!this.state.currentUser) {
                this.dom.loginView.style.display = 'flex';
                this.dom.appView.style.display = 'none';
            } else {
                this.dom.loginView.style.display = 'none';
                this.dom.appView.style.display = 'block';
                if (this.state.currentUser.role === 'admin') {
                    this.dom.adminView.style.display = 'flex';
                    this.dom.driverView.style.display = 'none';
                    this.dom.adminUsername.textContent = this.state.currentUser.name;
                    this.renderAdminPage();
                } else {
                    this.dom.adminView.style.display = 'none';
                    this.dom.driverView.style.display = 'block';
                    this.dom.driverUsername.textContent = this.state.currentUser.name;
                    this.renderDriverPage();
                }
            }
        }
        
        renderAdminPage() {
            this.dom.navItems.forEach(item => {
                const navItem = item.closest('.nav-item');
                const isActive = navItem.dataset.target === this.state.activeAdminPage;
                navItem.classList.toggle('bg-blue-600', isActive);
                navItem.classList.toggle('text-white', isActive);
            });
            let content = '';
            switch (this.state.activeAdminPage) {
                case 'chatbot': content = this.getChatbotHTML(); break;
                case 'dashboard': content = this.getDashboardHTML(); break;
                case 'fleet': content = this.getFleetHTML(); break;
                case 'shipments': content = this.getShipmentsHTML(); break;
            }
            this.dom.adminMainContent.innerHTML = content;

            if (this.state.activeAdminPage === 'fleet') {
                setTimeout(() => this.initMap(), 10); 
                document.getElementById('simulationBtn').addEventListener('click', () => this.toggleSimulation());
            } else if (this.state.activeAdminPage === 'chatbot') {
                const chatForm = document.getElementById('chatForm');
                if(chatForm) chatForm.addEventListener('submit', (e) => this.handleChatSubmit(e));
            }
        }
        
        renderDriverPage() {
            const task = this.state.driverTask;
            if (!task || task.status === 'no_task') {
                 this.dom.driverTaskContent.innerHTML = `<p class="text-center text-gray-600 text-lg">Hiện không có nhiệm vụ nào được giao.</p>`;
                 this.dom.driverActionButton.disabled = true;
                 this.dom.driverActionButton.innerHTML = 'Không có nhiệm vụ';
                 this.dom.driverActionButton.classList.add('bg-gray-400');
                 return;
            }

            const statusInfo = {
                on_route: { text: 'Đang di chuyển', color: 'text-blue-600', icon: 'fa-circle-notch fa-spin' },
                arrived: { text: 'Đã đến nơi', color: 'text-green-600', icon: 'fa-map-marker-alt' }
            };
            const currentStatus = statusInfo[task.status] || { text: 'N/A', color: 'text-gray-600', icon: 'fa-question-circle' };
            this.dom.driverTaskContent.innerHTML = `
                <div class="text-center mb-6">
                    <p class="text-gray-500 text-lg">Mã Lô Hàng</p>
                    <p class="font-mono text-4xl font-bold text-gray-800">${task.shipmentId}</p>
                </div>
                <div class="space-y-4">
                    <div class="bg-slate-50 p-4 rounded-lg border">
                        <p class="text-sm font-semibold text-gray-500">NHIỆM VỤ HIỆN TẠI</p>
                        <p class="text-xl font-bold text-gray-800">Lái xe tới: ${task.destination}</p>
                        <p class="text-base text-gray-600">Dự kiến đến: ${task.eta}</p>
                    </div>
                     <div class="bg-slate-50 p-4 rounded-lg border">
                        <p class="text-sm font-semibold text-gray-500">TRẠNG THÁI</p>
                        <p class="text-xl font-bold ${currentStatus.color} flex items-center justify-center">
                            <i class="fas ${currentStatus.icon} mr-2"></i>${currentStatus.text}
                        </p>
                    </div>
                </div>`;
            
            this.dom.driverActionButton.disabled = false;
            this.dom.driverActionButton.classList.remove('bg-gray-400');
            if (task.status === 'on_route') {
                 this.dom.driverActionButton.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Xác Nhận Đã Đến Nơi`;
            } else {
                 this.dom.driverActionButton.innerHTML = `<i class="fas fa-camera mr-2"></i> Hoàn Thành & Chụp Ảnh Biên Nhận`;
            }
        }

        handleDriverAction() {
            if (!this.state.driverTask) return;
            if (this.state.driverTask.status === 'on_route') {
                this.state.driverTask.status = 'arrived';
                this.renderDriverPage();
            } else {
                this.openPhotoModal();
            }
        }

        getDashboardHTML() {
            const onRoute = this.state.fleet.filter(v => v.status === 'on_route').length;
            const alerts = this.state.fleet.filter(v => v.hasAlert).length;
            const deliveries = this.state.fleet.filter(s => s.status === 'delivered').length;
            return `
                <div class="p-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-md border"><p class="text-sm text-gray-500">Xe đang đi</p><p class="text-4xl font-bold text-blue-600">${onRoute}</p></div>
                        <div class="bg-white p-6 rounded-xl shadow-md border"><p class="text-sm text-gray-500">Cảnh báo</p><p class="text-4xl font-bold ${alerts > 0 ? 'text-red-500' : 'text-gray-800'}">${alerts}</p></div>
                        <div class="bg-white p-6 rounded-xl shadow-md border"><p class="text-sm text-gray-500">Đã giao hôm nay</p><p class="text-4xl font-bold text-green-600">${deliveries}</p></div>
                    </div>

                    <div class="mt-8">
                        <h3 class="font-bold text-xl mb-4 text-gray-800">Đề Xuất từ AI</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-4 rounded-lg border shadow-sm">
                                <h4 class="font-bold text-blue-600"><i class="fas fa-lightbulb mr-2"></i>Đề xuất tối ưu hóa</h4>
                                <p>Tuyến đường cho xe <strong>71B-345.67</strong> có thể rút ngắn 15 phút bằng cách đi qua QL22 thay vì đường Xuyên Á.</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border shadow-sm">
                                <h4 class="font-bold text-red-600"><i class="fas fa-triangle-exclamation mr-2"></i>Cảnh báo tiềm ẩn</h4>
                                <p>Xe <strong>72C-888.99</strong> có thời gian dừng bất thường cao hơn 30% so với trung bình. Cần kiểm tra tình trạng kỹ thuật hoặc tài xế.</p>
                            </div>
                        </div>
                    </div>
                    
                     <div class="mt-8 bg-white p-6 rounded-xl shadow-md border">
                        <h3 class="font-bold text-xl mb-4">Hoạt động Gần đây</h3>
                        <div id="activityLog" class="h-60 overflow-y-auto space-y-3 pr-2">
                            <p class="text-gray-500">Không có hoạt động nào gần đây.</p>
                        </div>
                    </div>
                </div>`;
        }
        
        getFleetHTML() {
            return `
                <div class="h-full w-full flex flex-col">
                     <div class="p-4 bg-white/50 backdrop-blur-sm border-b z-10">
                        <h2 class="text-xl font-bold text-gray-800">Giám Sát Đội Xe</h2>
                    </div>
                    <div class="flex-1 grid grid-cols-1 lg:grid-cols-4">
                        <div class="lg:col-span-3 relative">
                            <div id="fleetMap"></div>
                        </div>
                        <div class="bg-white p-4 overflow-y-auto">
                            <h3 class="font-bold mb-4">Thông tin & Điều khiển</h3>
                            <button id="simulationBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mb-4">Bắt Đầu Giả Lập</button>
                             <div id="vehicleStatusList" class="space-y-2"></div>
                        </div>
                    </div>
                </div>`;
        }
        getShipmentsHTML() {
             let rows = this.state.shipments.map(s => {
                const statusMap = {
                    on_route: { text: 'Đang đi', class: 'bg-blue-100 text-blue-800' }, stopped: { text: 'Dừng', class: 'bg-red-100 text-red-800' },
                    delivered: { text: 'Đã giao', class: 'bg-green-100 text-green-800' }, at_warehouse: { text: 'Tại kho', class: 'bg-yellow-100 text-yellow-800' }
                };
                const statusInfo = statusMap[s.status] || { text: 'N/A', class: 'bg-gray-100 text-gray-800' };
                const destinationName = this.state.locations[s.destination_id]?.name || 'Không rõ';
                return `
                <tr class="hover:bg-gray-50">
                    <td class="p-3 font-mono text-sm">${s.id}</td><td class="p-3">${s.vehicle_id}</td>
                    <td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusInfo.class}">${statusInfo.text}</span></td>
                    <td class="p-3">${destinationName}</td><td class="p-3">N/A</td>
                </tr>`}).join('');
            return `
                <div class="p-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Quản Lý Lô Hàng</h2>
                    <div class="bg-white rounded-xl shadow-md border overflow-hidden">
                        <table class="min-w-full text-left text-sm">
                            <thead class="bg-gray-50 border-b"><tr class="text-gray-600">
                                <th class="p-3 font-semibold">Mã Lô Hàng</th><th class="p-3 font-semibold">Xe</th>
                                <th class="p-3 font-semibold">Trạng Thái</th><th class="p-3 font-semibold">Điểm Đến</th>
                                <th class="p-3 font-semibold">Cập nhật lúc</th>
                            </tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                </div>`;
        }

        getChatbotHTML() {
            return `
                <div class="h-full w-full flex flex-col p-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Trợ lý AI Logistics</h2>
                    <div class="flex-1 bg-white rounded-xl shadow-md border p-4 flex flex-col">
                        <div id="chatHistory" class="flex-1 overflow-y-auto mb-4 space-y-4 pr-2">
                            <div class="flex items-start gap-3">
                                <div class="bg-blue-500 text-white rounded-full h-8 w-8 flex-shrink-0 flex items-center justify-center">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="bg-slate-100 p-3 rounded-lg">
                                    <p class="text-sm">Xin chào! Tôi có thể giúp gì cho bạn hôm nay? Hãy hỏi tôi về tình trạng xe hoặc các vấn đề vận hành.</p>
                                </div>
                            </div>
                        </div>
                        <div class="border-t pt-4">
                            <form id="chatForm" class="flex items-center gap-3">
                                <input type="text" id="chatInput" placeholder="Nhập câu hỏi của bạn..." class="w-full p-3 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async handleLogin(event) {
            event.preventDefault();
            const email = event.target.username.value;
            const password = event.target.password.value;
            this.dom.loginError.textContent = ''; 

            const loginButton = this.dom.loginForm.querySelector('button[type="submit"]');
            const originalButtonText = loginButton.innerHTML;
            loginButton.disabled = true;
            loginButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Đang đăng nhập...`;

            try {
                const usersData = await this.fetchBaserowTable(this.apiConfig.tables.users);
                const user = usersData.find(u => u.email === email && u.pass === password);

                if (user) {
                    const role = user.role ? user.role.value.toLowerCase() : 'driver';
                    this.state.currentUser = { id: user.id, name: user.email, role: role };
                    this.state.threadId = `user_thread_${user.id}`; 
                    await this.loadApiData(); 
                    this.render();
                } else {
                    this.dom.loginError.textContent = 'Email hoặc mật khẩu không đúng.';
                }
            } catch (error) {
                console.error('Login error details:', error);
                if (error.message.includes('401')) {
                    this.dom.loginError.textContent = 'Lỗi xác thực (401). Vui lòng kiểm tra lại Database Token.';
                } else if (error instanceof TypeError) {
                    this.dom.loginError.textContent = 'Lỗi mạng hoặc CORS. Không thể kết nối tới server.';
                } else {
                    this.dom.loginError.textContent = `Đã có lỗi xảy ra. Vui lòng thử lại.`;
                }
            } finally {
                loginButton.disabled = false;
                loginButton.innerHTML = originalButtonText;
            }
        }
        logout() {
            if (this.state.simulation.running) this.toggleSimulation();
            this.state.currentUser = null; 
            if (this.state.map) {
                this.state.map.remove();
                this.state.map = null;
            }
            this.state.fleet = [];
            this.state.shipments = [];
            this.state.locations = {};
            this.state.threadId = null; 
            this.render();
        }
        
        initMap() {
            if (this.state.map) { this.state.map.remove(); }
            const mapElement = document.getElementById('fleetMap');
            if (!mapElement) return;

            this.state.map = L.map('fleetMap').setView([15.9, 107.8], 6); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(this.state.map);

            for (const id in this.state.locations) {
                const loc = this.state.locations[id];
                const iconHtml = `<div class="p-1 rounded-full ${loc.type === 'warehouse' ? 'bg-sky-500' : 'bg-green-500'} border-2 border-white shadow-lg"><i class="fas ${loc.type === 'warehouse' ? 'fa-warehouse' : 'fa-store'} text-white"></i></div>`;
                const customIcon = L.divIcon({ html: iconHtml, className: 'flex items-center justify-center', iconSize: [24, 24] });
                L.marker(loc.coords, { icon: customIcon }).addTo(this.state.map)
                    .bindPopup(`<b>${loc.name}</b>`);
            }
            
            this.updateMapState();
        }

        toggleSimulation() {
            const btn = document.getElementById('simulationBtn');
            if (this.state.simulation.running) {
                clearInterval(this.state.simulation.interval);
                this.state.simulation.running = false;
                btn.innerHTML = 'Bắt Đầu Giả Lập'; btn.classList.replace('bg-red-600', 'bg-blue-600');
            } else {
                this.state.simulation.running = true;
                this.state.simulation.interval = setInterval(() => this.simulationLoop(), 100);
                btn.innerHTML = 'Dừng Giả Lập'; btn.classList.replace('bg-blue-600', 'bg-red-600');
            }
        }
        simulationLoop() {
            this.state.fleet.forEach(v => {
                if(v.status === 'on_route') { v.progress += 0.005; }
                if(v.progress >= 1) { v.progress = 1; v.status = 'delivered'; }
            });
            this.updateMapState();
        }
        
        updateMapState() {
            if (!this.state.map) return;
            const listEl = document.getElementById('vehicleStatusList');
            if (!listEl) return;
            
            let listHTML = '';

            this.state.fleet.forEach(v => {
                if (v.route && v.route[0] && v.route[1] && this.state.locations[v.route[0]] && this.state.locations[v.route[1]]) {
                    const startCoords = this.state.locations[v.route[0]].coords;
                    const endCoords = this.state.locations[v.route[1]].coords;
                    const lat = startCoords[0] + (endCoords[0] - startCoords[0]) * v.progress;
                    const lng = startCoords[1] + (endCoords[1] - startCoords[1]) * v.progress;
                    v.coords = [lat, lng]; 
                    
                    const iconHtml = `<div class="p-1 rounded-full ${v.hasAlert ? 'bg-red-500' : 'bg-blue-500'} border-2 border-white shadow-lg"><i class="fas fa-truck text-white"></i></div>`;
                    const customIcon = L.divIcon({ html: iconHtml, className: 'flex items-center justify-center', iconSize: [24, 24] });
                    
                    if (this.state.vehicleMarkers[v.id]) {
                        this.state.vehicleMarkers[v.id].setLatLng([lat, lng]).setIcon(customIcon);
                    } else {
                        this.state.vehicleMarkers[v.id] = L.marker([lat, lng], { icon: customIcon }).addTo(this.state.map);
                    }
                    this.state.vehicleMarkers[v.id].bindPopup(`<b>Xe: ${v.id}</b><br>Trạng thái: ${v.status}`);
                }

                const statusMap = {
                    on_route: { text: 'Đang đi', icon: 'fa-truck-fast', color: 'blue-500' },
                    stopped: { text: 'Dừng bất thường', icon: 'fa-triangle-exclamation', color: 'red-500' },
                    at_warehouse: { text: 'Tại kho', icon: 'fa-warehouse', color: 'yellow-500' },
                    delivered: { text: 'Đã giao', icon: 'fa-check-circle', color: 'green-500' }
                };
                const info = statusMap[v.status] || { text: 'Không rõ', icon: 'fa-question-circle', color: 'gray-500' };
                listHTML += `
                    <div class="p-3 rounded-lg ${v.hasAlert ? 'bg-red-100 border border-red-300' : 'bg-slate-50 border'}">
                        <p class="font-bold text-gray-800">${v.id}</p>
                        <p class="text-sm text-${info.color}"><i class="fas ${info.icon} mr-2"></i>${info.text}</p>
                    </div>`;
            });
            listEl.innerHTML = listHTML;
        }

        async handleChatSubmit(event) {
            event.preventDefault();
            const chatInput = document.getElementById('chatInput');
            const chatHistory = document.getElementById('chatHistory');
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            chatHistory.innerHTML += `
                <div class="flex items-start gap-3 justify-end">
                    <div class="bg-slate-600 text-white p-3 rounded-lg">
                        <p class="text-sm">${userMessage}</p>
                    </div>
                </div>`;
            chatInput.value = '';
            chatHistory.scrollTop = chatHistory.scrollHeight;

            const typingId = `bot-typing-${Date.now()}`;
            chatHistory.innerHTML += `
                <div class="flex items-start gap-3" id="${typingId}">
                    <div class="bg-blue-500 text-white rounded-full h-8 w-8 flex-shrink-0 flex items-center justify-center">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="bg-slate-100 p-3 rounded-lg">
                        <div class="flex items-center gap-1.5">
                            <div class="h-2 w-2 bg-slate-400 rounded-full animate-bounce [animation-delay:-0.3s]"></div>
                            <div class="h-2 w-2 bg-slate-400 rounded-full animate-bounce [animation-delay:-0.15s]"></div>
                            <div class="h-2 w-2 bg-slate-400 rounded-full animate-bounce"></div>
                        </div>
                    </div>
                </div>`;
            chatHistory.scrollTop = chatHistory.scrollHeight;

            try {
                const webhookUrl = 'https://aps.aibm.space/webhook/scm1';
                const payload = {
                    task: 'chatbot',
                    prompt: userMessage,
                    email: this.state.currentUser.name,
                    threadid: this.state.threadId,
                    depart: 'Logistics'
                };

                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Lỗi HTTP! Trạng thái: ${response.status}`);
                }

                const data = await response.json();
                const botReply = data[0]?.output || "Xin lỗi, tôi không thể xử lý yêu cầu này.";

                const typingElement = document.getElementById(typingId);
                if (typingElement) {
                    typingElement.querySelector('.bg-slate-100').innerHTML = `<p class="text-sm">${botReply}</p>`;
                }

            } catch (error) {
                console.error('Lỗi API Chatbot:', error);
                const typingElement = document.getElementById(typingId);
                if (typingElement) {
                    typingElement.querySelector('.bg-slate-100').innerHTML = `<p class="text-sm text-red-500">Lỗi: Không thể kết nối với trợ lý AI.</p>`;
                }
            }
        }

        openPhotoModal() {
            const modalContent = `
                <div class="bg-black w-full max-w-lg mx-auto rounded-lg text-white p-4 text-center">
                    <h3 class="text-xl font-bold mb-4">Chụp Ảnh Biên Nhận</h3>
                    <div class="bg-gray-700 h-64 flex items-center justify-center rounded-md mb-4 text-gray-400">
                        <i class="fas fa-camera text-6xl"></i>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="app.closeModal()" class="w-full bg-gray-600 hover:bg-gray-500 py-2 rounded">Hủy</button>
                        <button onclick="app.confirmPhotoUpload()" class="w-full bg-blue-600 hover:bg-blue-500 py-2 rounded">Xác nhận</button>
                    </div>
                </div>`;
            this.showModal(modalContent);
        }
        confirmPhotoUpload() {
            this.closeModal();
            this.showModal(`<div class="bg-white p-6 rounded-lg text-center"><i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i><p>Tải ảnh lên thành công!</p></div>`);
            setTimeout(() => this.closeModal(), 2000);
            if(this.state.driverTask) {
                this.state.driverTask.status = 'delivered';
                this.renderDriverPage();
            }
        }
        showModal(contentHTML) {
            this.dom.modalContainer.innerHTML = `
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4">
                    <div class="modal-content transform scale-95">${contentHTML}</div>
                </div>`;
            this.dom.modalContainer.classList.remove('hidden');
            setTimeout(() => {
                const overlay = this.dom.modalContainer.querySelector('.modal-overlay');
                const content = this.dom.modalContainer.querySelector('.modal-content');
                if (overlay) overlay.classList.add('opacity-100');
                if (content) content.classList.add('scale-100');
            }, 10);
        }
        closeModal() {
            const overlay = this.dom.modalContainer.querySelector('.modal-overlay');
            if (overlay) {
                overlay.classList.remove('opacity-100');
                setTimeout(() => this.dom.modalContainer.classList.add('hidden'), 300);
            } else {
                 this.dom.modalContainer.classList.add('hidden');
            }
        }
    }

    const app = new LogisticsApp();
    </script>
</body>
</html>

